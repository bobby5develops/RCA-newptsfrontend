/// <reference path="../../../tsd.d.ts" />

import angular = require("angular");
import mock = require("angular-mocks-shim");
import angularCookies = require("angular-cookies");
import angularLogger = require("angular-logger-shim");
import lodash = require("lodash");
import uiRouter = require("angular-ui-router");

import {UserPreferences, Constants } from "cd-node-utils";
import {Constants as GeoShapeSearchConstants, GeoShapeSearchService} from "../../../shared/GeoShapeSearch/GeoShapeSearchModule";
import {moduleName as AuthenticationModuleName, AuthenticationService} from "../../../shared/Authentication/AuthenticationModule"
import {moduleName as EnvironmentModuleName, EnvironmentConfiguration} from "../../../shared/Environment/EnvironmentModule";
import {Constants as TransactionFiltersConstants, Templates as TransactionFiltersTemplates, TransactionFiltersRouteHelperService, TransactionFiltersService, TransactionFiltersRouteOptions} from "../../../shared/TransactionFilters/TransactionFiltersModule";

'use strict';

describe('Controller: TransactionFiltersRouteHelperService', () => {
    var log: ng.ILogService;
    var environment: EnvironmentConfiguration;
    var transactionFiltersService: TransactionFiltersService;
    var transactionFiltersRouteHelperService: TransactionFiltersRouteHelperService;
    var authenticationService: AuthenticationService;


    var cookieStore: ng.cookies.ICookiesService;
    var cookieStoreShouldReturnCookie: boolean = true;

    // load the service's module
    beforeEach(mock.module(EnvironmentModuleName));
    beforeEach(mock.module(AuthenticationModuleName));
    beforeEach(mock.module(angularLogger));
    beforeEach(mock.module(angularCookies));
    beforeEach(mock.module(uiRouter));
    beforeEach(mock.module(GeoShapeSearchConstants.ModuleName));
    beforeEach(mock.module(TransactionFiltersTemplates));
    beforeEach(mock.module(TransactionFiltersConstants.ModuleName));

    // instantiate service
    beforeEach(inject(function (_$log_: ng.ILogService,
                                _EnvironmentConfiguration_: EnvironmentConfiguration,
                                $cookieStore: ng.cookies.ICookiesService,
                                _TransactionFiltersService_: TransactionFiltersService,
                                _AuthenticationService_: AuthenticationService) {
        log = _$log_;
        environment = _EnvironmentConfiguration_;
        cookieStore = $cookieStore;
        transactionFiltersService = _TransactionFiltersService_;
        authenticationService = _AuthenticationService_;

        spyOn(cookieStore, "put").and.callFake(()=> {
        });
        spyOn(cookieStore, "remove").and.callFake(()=> {
        });
        spyOn(cookieStore, "get").and.callFake((key: string)=>
            cookieStoreShouldReturnCookie && key === AuthenticationService.authenticationCookieName
                ? user_jwt
                : null);
    }));

    beforeEach(inject(function (_TransactionFiltersRouteHelperService_: TransactionFiltersRouteHelperService) {
        transactionFiltersRouteHelperService = _TransactionFiltersRouteHelperService_;
        transactionFiltersService.mapBounds.northeast = mapBounds.northeast;
        transactionFiltersService.mapBounds.southwest = mapBounds.southwest;
        transactionFiltersService.MapCenter.latitude = mapCenter.latitude;
        transactionFiltersService.MapCenter.longitude = mapCenter.longitude;
        transactionFiltersService.MapZoom = mapZoom;
    }));


    afterEach(function () {
    });

    it('Should return null by default if a geoshape is present', () => {
        transactionFiltersService.searchGeoShape = searchGeoShape;
        expect(transactionFiltersRouteHelperService.getParams()).toEqual(null);
    });

    it('Should return defaultParams when ignored if a geoshape is present', () => {
        transactionFiltersService.searchGeoShape = searchGeoShape;

        const transactionFiltersRouteOptions = new TransactionFiltersRouteOptions();
        transactionFiltersRouteOptions.ignoreGeoShape = true;

        expect(transactionFiltersRouteHelperService.getParams(transactionFiltersRouteOptions)).toEqual(defaultParams);
    });

    it('Should not return bounds when requested', () => {
        const transactionFiltersRouteOptions = new TransactionFiltersRouteOptions();
        transactionFiltersRouteOptions.includeBounds = false;

        expect(transactionFiltersRouteHelperService.getParams(transactionFiltersRouteOptions)).toEqual(paramsWithoutBounds);
    });
});

var user_jwt = "%22eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhY2NvdW50VXNlcl9pZCI6NzgyNDEsImZpcnN0TmFtZV90eCI6IlN0YW5sZXkiLCJsYXN0TmFtZV90eCI6IkdvbGRtYW4iLCJhY2NvdW50QWRtaW5fZmciOnRydWUsInN5c3RlbUFkbWluX2ZnIjpmYWxzZSwiaWF0IjoxNDQyNjA4OTU1LCJleHAiOjE0NDI2OTUzNTV9.MHUln9RsS_qCfGsdWl-Yu2tpkyEwYr8XTqr2QKdKWLs%22";

var mapBounds = {
    northeast: {latitude: 52.244821434728095, longitude: -53.33447265625},
    southwest: {latitude: 36.70832769052502, longitude: -92.66552734375}
};

var mapCenter = {latitude: 45, longitude: -73};

var mapZoom = 5;

var defaultParams = {
    lat: mapCenter.latitude,
    lon: mapCenter.longitude,
    zoom: mapZoom,
    view: 'split',
    sw: `${mapBounds.southwest.longitude},${mapBounds.southwest.latitude}`,
    ne: `${mapBounds.northeast.longitude},${mapBounds.northeast.latitude}`
};

var paramsWithoutBounds = {
    lat: mapCenter.latitude,
    lon: mapCenter.longitude,
    zoom: mapZoom,
    view: 'split'
};

var searchGeoShape = {
    "type": "Polygon",
    "coordinates": [[[-77.61474698781967, 45.657292675994626], [-77.5954363421356, 45.65717327198773], [-77.57613182346591, 45.65681509786604], [-77.55683955664324, 45.65621826731305], [-77.5375656621377, 45.6553829697561], [-77.51831625387831, 45.65430947029882], [-77.49909743707798, 45.65299810962641], [-77.47991530606242, 45.651449303884085], [-77.46077594210499, 45.64966354452858], [-77.44168541126777, 45.647641398152814], [-77.4226497622505, 45.64538350628387], [-77.403675024248, 45.6428905851543], [-77.38476720481765, 45.640163425446964], [-77.36593228775729, 45.63720289201347], [-77.34717623099539, 45.634009923566346], [-77.32850496449402, 45.63058553234517], [-77.30992438816531, 45.62693080375679], [-77.29144036980364, 45.62304689598975], [-77.27305874303295, 45.61893503960327], [-77.25478530527153, 45.61459653709081], [-77.23662581571449, 45.61003276241859], [-77.21858599333473, 45.60524516053913], [-77.20067151490429, 45.6002352468803], [-77.18288801303589, 45.59500460680985], [-77.16524107424618, 45.589554895075864], [-77.14773623704156, 45.58388783522339], [-77.13037899002694, 45.57800521898749], [-77.11317477003911, 45.571908905663044], [-77.09612896030472, 45.565600821451596], [-77.0792468886242, 45.55908295878559], [-77.06253382558208, 45.55235737563018], [-77.0459949827848, 45.54542619476335], [-77.02963551112623, 45.538291603034075], [-77.01346049908204, 45.53095585059945], [-76.9974749710338, 45.52342125014084], [-76.98168388562243, 45.51569017605951], [-76.96609213413291, 45.50776506365204], [-76.9507045389102, 45.49964840826615], [-76.9355258518068, 45.49134276443694], [-76.92056075266294, 45.482850745004356], [-76.90581384781973, 45.474175020211966], [-76.89128966866559, 45.46531831678764], [-76.87699267021696, 45.456283417006574], [-76.86292722973303, 45.4470731577369], [-76.84909764536587, 45.43769042946855], [-76.83550813484487, 45.42813817532559], [-76.8221628341978, 45.41841939006264], [-76.80906579650718, 45.40853711904578], [-76.79622099070315, 45.39849445721825], [-76.78363230039292, 45.38829454805166], [-76.77130352272695, 45.37794058248289], [-76.75923836730237, 45.36743579783741], [-76.74744045510351, 45.35678347673918], [-76.73591331748042, 45.34598694600791], [-76.72466039516416, 45.335049575543906], [-76.713685037321, 45.323974777201094], [-76.70299050064364, 45.312766003648605], [-76.69257994848095, 45.30142674722155], [-76.68245645000576, 45.289960538761235], [-76.67262297942057, 45.2783709464455], [-76.66308241520181, 45.26666157460942], [-76.65383753938181, 45.25483606255719], [-76.64489103686924, 45.24289808336522], [-76.63624549480767, 45.230851342677354], [-76.62790340197193, 45.21869957749228], [-76.61986714820273, 45.206446554944], [-76.61213902387863, 45.194096071075386], [-76.60472121942644, 45.18165194960578], [-76.59761582486868, 45.169118040692574], [-76.5908248294084, 45.1564982196878], [-76.58435012105167, 45.14379638588962], [-76.57819348626646, 45.13101646128959], [-76.57235660967899, 45.118162389316055], [-76.56684107380624, 45.105238133573856], [-76.56164835882453, 45.09224767658135], [-76.55677984237497, 45.07919501850453], [-76.55223679940354, 45.06608417588926], [-76.54802040203776, 45.052919180391626], [-76.5441317194975, 45.03970407750722], [-76.54057171804129, 45.02644292529939], [-76.53734126094685, 45.01313979312724], [-76.5344411085257, 44.99979876037356], [-76.53187191817148, 44.9864239151732], [-76.52963424444204, 44.97301935314233], [-76.52772853917389, 44.95958917610884], [-76.52615515162984, 44.94613749084455], [-76.5249143286785, 44.93266840779925], [-76.52400621500567, 44.91918603983738], [-76.52343085335718, 44.90569450097746], [-76.5231881848124, 44.89219790513464], [-76.52327804908867, 44.878700364866965], [-76.5237001848754, 44.86520599012548], [-76.52445423019799, 44.85171888700874], [-76.52553972281072, 44.838243156521884], [-76.5269561006188, 44.82478289334087], [-76.5287027021281, 44.81134218458196], [-76.53077876692299, 44.79792510857703], [-76.53318343617133, 44.78453573365479], [-76.53591575315647, 44.771178116928596], [-76.53897466383552, 44.757856303090755], [-76.5423590174234, 44.74457432321402], [-76.54606756700252, 44.73133619356033], [-76.55009897015708, 44.71814591439728], [-76.55445178963231, 44.70500746882244], [-76.55912449401717, 44.69192482159603], [-76.56411545845083, 44.67890191798209], [-76.56942296535203, 44.66594268259843], [-76.57504520517136, 44.65305101827577], [-76.58098027716483, 44.64023080492617], [-76.58722619019, 44.62748589842118], [-76.5937808635224, 44.61482012947981], [-76.60064212769299, 44.60223730256677], [-76.6078077253461, 44.58974119480099], [-76.6152753121163, 44.57733555487496], [-76.62304245752534, 44.565024101984775], [-76.63110664589743, 44.55281052477145], [-76.63946527729303, 44.5406984802736], [-76.64811566846043, 44.528691592891576], [-76.65705505380527, 44.51679345336356], [-76.66628058637616, 44.50500761775352], [-76.67578933886796, 44.49333760645153], [-76.68557830464044, 44.48178690318641], [-76.69564439875302, 44.47035895405101], [-76.70598445901481, 44.45905716654035], [-76.71659524704938, 44.44788490860271], [-76.72747344937449, 44.436845507703914], [-76.7386156784952, 44.425942249905034], [-76.75001847401126, 44.41517837895349], [-76.76167830373771, 44.404557095388], [-76.77359156483828, 44.39408155565733], [-76.78575458497113, 44.38375487125304], [-76.79816362344746, 44.37358010785646], [-76.81081487240107, 44.363560284500004], [-76.82370445797, 44.35369837274287], [-76.83682844148899, 44.34399729586147], [-76.8501828206928, 44.33445992805453], [-76.8637635309297, 44.325089093663166], [-76.87756644638546, 44.315887566405856], [-76.89158738131647, 44.30685806862865], [-76.90582209129309, 44.29800327057064], [-76.9202662744512, 44.28932578964475], [-76.93491557275331, 44.28082818973409], [-76.94976557325771, 44.27251298050384], [-76.96481180939583, 44.26438261672897], [-76.98004976225775, 44.25643949763762], [-76.99547486188527, 44.24868596627052], [-77.0110824885719, 44.24112430885636], [-77.0268679741705, 44.233756754203256], [-77.04282660340732, 44.226585473106454], [-77.05895361520277, 44.21961257777232], [-77.07524420399824, 44.212840121258594], [-77.09169352108927, 44.206270096931185], [-77.10829667596414, 44.19990443793747], [-77.12504873764817, 44.193745016696134], [-77.1419447360534, 44.18779364440374], [-77.15897966333318, 44.182052070558], [-77.17614847524152, 44.17652198249778], [-77.19344609249742, 44.1712050049601], [-77.21086740215344, 44.16610269965392], [-77.22840725896788, 44.161216564850974], [-77.24606048678214, 44.156548034993634], [-77.26382187990066, 44.152098480319786], [-77.28168620447525, 44.14786920650489], [-77.29964819989243, 44.14386145432127], [-77.31770258016377, 44.140076399314474], [-77.33584403532012, 44.13651515149699], [-77.35406723280738, 44.133178755059305], [-77.3723668188859, 44.1300681880982], [-77.39073742003211, 44.12718436236246], [-77.40917364434182, 44.124528123016006], [-77.42767008293674, 44.12210024841838], [-77.4462213113718, 44.11990144992281], [-77.464821891045, 44.11793237169166], [-77.48346637060865, 44.116193590529384], [-77.50214928738177, 44.114685615733094], [-77.52086516876409, 44.11340888896059], [-77.53960853365112, 44.112363784115956], [-77.55837389385005, 44.11155060725278], [-77.57715575549634, 44.11096959649493], [-77.59594862047129, 44.1106209219749], [-77.61474698781967, 44.11050468578978], [-77.63354535516805, 44.1106209219749], [-77.65233822014301, 44.11096959649493], [-77.6711200817893, 44.11155060725278], [-77.68988544198817, 44.112363784115956], [-77.70862880687525, 44.11340888896059], [-77.72734468825757, 44.114685615733094], [-77.74602760503069, 44.116193590529384], [-77.76467208459434, 44.11793237169166], [-77.78327266426754, 44.11990144992281], [-77.8018238927026, 44.12210024841838], [-77.82032033129752, 44.124528123016006], [-77.83875655560723, 44.12718436236246], [-77.85712715675339, 44.1300681880982], [-77.87542674283196, 44.133178755059305], [-77.89364994031922, 44.13651515149699], [-77.91179139547557, 44.140076399314474], [-77.92984577574691, 44.14386145432127], [-77.9478077711641, 44.14786920650489], [-77.96567209573868, 44.152098480319786], [-77.9834334888572, 44.156548034993634], [-78.00108671667147, 44.161216564850974], [-78.0186265734859, 44.16610269965392], [-78.03604788314186, 44.1712050049601], [-78.05334550039782, 44.17652198249778], [-78.07051431230616, 44.182052070558], [-78.08754923958594, 44.18779364440374], [-78.10444523799117, 44.193745016696134], [-78.1211972996752, 44.19990443793747], [-78.13780045455007, 44.206270096931185], [-78.1542497716411, 44.212840121258594], [-78.17054036043658, 44.21961257777232], [-78.18666737223202, 44.226585473106454], [-78.20262600146884, 44.233756754203256], [-78.21841148706744, 44.24112430885636], [-78.23401911375407, 44.24868596627052], [-78.2494442133816, 44.25643949763762], [-78.26468216624352, 44.26438261672897], [-78.27972840238164, 44.27251298050384], [-78.29457840288603, 44.28082818973409], [-78.30922770118815, 44.28932578964475], [-78.32367188434625, 44.29800327057064], [-78.33790659432287, 44.30685806862865], [-78.35192752925389, 44.315887566405856], [-78.36573044470958, 44.325089093663166], [-78.37931115494655, 44.33445992805453], [-78.3926655341503, 44.34399729586147], [-78.40578951766935, 44.35369837274287], [-78.41867910323828, 44.363560284500004], [-78.43133035219188, 44.37358010785646], [-78.44373939066821, 44.38375487125304], [-78.45590241080106, 44.39408155565733], [-78.46781567190163, 44.404557095388], [-78.47947550162809, 44.41517837895349], [-78.49087829714415, 44.425942249905034], [-78.50202052626486, 44.436845507703914], [-78.5128987285899, 44.44788490860271], [-78.52350951662453, 44.45905716654035], [-78.53384957688627, 44.47035895405101], [-78.5439156709989, 44.48178690318641], [-78.55370463677133, 44.49333760645153], [-78.56321338926318, 44.50500761775352], [-78.57243892183408, 44.51679345336356], [-78.58137830717885, 44.528691592891576], [-78.59002869834632, 44.5406984802736], [-78.59838732974191, 44.55281052477145], [-78.606451518114, 44.565024101984775], [-78.61421866352305, 44.57733555487496], [-78.62168625029324, 44.58974119480099], [-78.62885184794635, 44.60223730256677], [-78.63571311211695, 44.61482012947981], [-78.64226778544935, 44.62748589842118], [-78.64851369847446, 44.64023080492617], [-78.65444877046798, 44.65305101827577], [-78.66007101028731, 44.66594268259843], [-78.66537851718851, 44.67890191798209], [-78.67036948162217, 44.69192482159603], [-78.67504218600703, 44.70500746882244], [-78.67939500548226, 44.71814591439728], [-78.68342640863682, 44.73133619356033], [-78.68713495821595, 44.74457432321402], [-78.69051931180383, 44.757856303090755], [-78.69357822248287, 44.771178116928596], [-78.69631053946802, 44.78453573365479], [-78.69871520871635, 44.79792510857703], [-78.70079127351124, 44.81134218458196], [-78.70253787502054, 44.82478289334087], [-78.70395425282862, 44.838243156521884], [-78.70503974544135, 44.85171888700874], [-78.70579379076389, 44.86520599012548], [-78.70621592655067, 44.878700364866965], [-78.70630579082695, 44.89219790513464], [-78.70606312228216, 44.90569450097746], [-78.70548776063367, 44.91918603983738], [-78.70457964696084, 44.93266840779925], [-78.7033388240095, 44.94613749084455], [-78.70176543646545, 44.95958917610884], [-78.69985973119731, 44.97301935314233], [-78.69762205746787, 44.9864239151732], [-78.69505286711365, 44.99979876037356], [-78.6921527146925, 45.01313979312724], [-78.68892225759805, 45.02644292529939], [-78.68536225614184, 45.03970407750722], [-78.68147357360158, 45.052919180391626], [-78.6772571762358, 45.06608417588926], [-78.67271413326438, 45.07919501850453], [-78.66784561681482, 45.09224767658135], [-78.6626529018331, 45.105238133573856], [-78.65713736596035, 45.118162389316055], [-78.65130048937289, 45.13101646128959], [-78.64514385458767, 45.14379638588962], [-78.63866914623094, 45.1564982196878], [-78.63187815077066, 45.169118040692574], [-78.6247727562129, 45.18165194960578], [-78.61735495176072, 45.194096071075386], [-78.60962682743661, 45.206446554944], [-78.60159057366735, 45.21869957749228], [-78.59324848083162, 45.230851342677354], [-78.5846029387701, 45.24289808336522], [-78.57565643625753, 45.25483606255719], [-78.56641156043747, 45.26666157460942], [-78.55687099621878, 45.2783709464455], [-78.54703752563358, 45.289960538761235], [-78.53691402715839, 45.30142674722155], [-78.5265034749957, 45.312766003648605], [-78.51580893831834, 45.323974777201094], [-78.50483358047518, 45.335049575543906], [-78.49358065815892, 45.34598694600791], [-78.48205352053583, 45.35678347673918], [-78.47025560833697, 45.36743579783741], [-78.45819045291239, 45.37794058248289], [-78.44586167524642, 45.38829454805166], [-78.4332729849362, 45.39849445721825], [-78.42042817913216, 45.40853711904578], [-78.40733114144155, 45.41841939006264], [-78.39398584079447, 45.42813817532559], [-78.38039633027347, 45.43769042946855], [-78.36656674590631, 45.4470731577369], [-78.35250130542238, 45.456283417006574], [-78.33820430697375, 45.46531831678764], [-78.32368012781961, 45.474175020211966], [-78.30893322297635, 45.482850745004356], [-78.29396812383254, 45.49134276443694], [-78.27878943672914, 45.49964840826615], [-78.26340184150644, 45.50776506365204], [-78.24781009001691, 45.51569017605951], [-78.23201900460555, 45.52342125014084], [-78.2160334765573, 45.53095585059945], [-78.19985846451311, 45.538291603034075], [-78.18349899285454, 45.54542619476335], [-78.16696015005726, 45.55235737563018], [-78.15024708701515, 45.55908295878559], [-78.13336501533462, 45.565600821451596], [-78.11631920560023, 45.571908905663044], [-78.09911498561235, 45.57800521898749], [-78.08175773859773, 45.58388783522339], [-78.0642529013931, 45.589554895075864], [-78.04660596260345, 45.59500460680985], [-78.02882246073506, 45.6002352468803], [-78.01090798230462, 45.60524516053913], [-77.99286815992485, 45.61003276241859], [-77.97470867036782, 45.61459653709081], [-77.9564352326064, 45.61893503960327], [-77.9380536058357, 45.62304689598975], [-77.91956958747403, 45.62693080375679], [-77.90098901114533, 45.63058553234517], [-77.8823177446439, 45.634009923566346], [-77.86356168788205, 45.63720289201347], [-77.8447267708217, 45.640163425446964], [-77.82581895139134, 45.6428905851543], [-77.80684421338884, 45.64538350628387], [-77.78780856437157, 45.647641398152814], [-77.76871803353436, 45.64966354452858], [-77.74957866957692, 45.651449303884085], [-77.73039653856131, 45.65299810962641], [-77.71117772176098, 45.65430947029882], [-77.69192831350165, 45.6553829697561], [-77.6726544189961, 45.65621826731305], [-77.65336215217343, 45.65681509786604], [-77.63405763350374, 45.65717327198773], [-77.61474698781967, 45.657292675994626]]]
};
